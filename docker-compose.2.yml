version: "3.9"

services:

  nginx-proxy:
    image: jc21/nginx-proxy-manager:2.11.3
    container_name: nginx-proxy-manager
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    environment:
      DB_MYSQL_HOST: npm-db
      DB_MYSQL_PORT: 3306
      DB_MYSQL_USER: npm
      DB_MYSQL_PASSWORD: ${NPM_DB_PASSWORD}
      DB_MYSQL_NAME: npm

      DISABLE_IPV6: "true"

    volumes:
      - /srv/data/nginx-proxy/data:/data
      - /srv/data/nginx-proxy/letsencrypt:/etc/letsencrypt

    depends_on:
      - npm-db

    networks:
      - web-proxy
      - internal-db

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
        reservations:
          memory: 512M

    healthcheck:
      test: ["CMD", "/usr/bin/check-health"]
      interval: 30s
      timeout: 5s
      retries: 3

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"


  npm-db:
    image: mariadb:11.3
    container_name: npm-mariadb
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: npm
      MYSQL_USER: npm
      MYSQL_PASSWORD: ${NPM_DB_PASSWORD}

    volumes:
      - /srv/data/nginx-proxy/mysql:/var/lib/mysql

    command: >
      --innodb-buffer-pool-size=256M
      --innodb-log-file-size=64M
      --max-connections=200
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci

    networks:
      - internal-db

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 5s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"


networks:
  web-proxy:
    external: true

  internal-db:
    driver: bridge
